<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>File Streams for Big Data • paquet</title>
<script src="deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="deps/headroom-0.11.0/headroom.min.js"></script><script src="deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="deps/search-1.0.0/fuse.min.js"></script><script src="deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="pkgdown.js"></script><meta property="og:title" content="File Streams for Big Data">
<meta name="description" content="Provides tools for creating and managing file streams in support of large simulation or other outputs.">
<meta property="og:description" content="Provides tools for creating and managing file streams in support of large simulation or other outputs.">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="index.html">paquet</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.1.0.9000</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="reference/index.html">Reference</a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="articles/file-stream.html">File Stream Workflow</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/metrumresearchgroup/paquet/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-home">
<div class="row">
  <main id="main" class="col-md-9"><div class="section level1">
<div class="page-header"><h1 id="paquet">paquet<a class="anchor" aria-label="anchor" href="#paquet"></a>
</h1></div>
<!-- badges: start -->
<!-- badges: end -->
<p>paquet helps you create and manage file streams for saving large outputs which are created in chunks or packets.</p>
<p>For example, large simulation job might be split up into packets to be processed in parallel. Using paquet, each worker can get a unique output file name for saving the result of that packet to a reserved space on disk so that large simulation results are not returned to the head node. Results are stored in a way that allows efficient handling with fst file format or feather / arrow data sets.</p>
<div class="section level2">
<h2 id="installation">Installation<a class="anchor" aria-label="anchor" href="#installation"></a>
</h2>
<p>You can install the development version of paquet from <a href="https://github.com/metrumresearchgroup/paquet" class="external-link">GitHub</a> with:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># install.packages("devtools")</span></span>
<span><span class="fu">devtools</span><span class="fu">::</span><span class="fu">install_github</span><span class="op">(</span><span class="st">"metrumresearchgroup/paquet"</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="example">Example<a class="anchor" aria-label="anchor" href="#example"></a>
</h2>
<p>We will illustrate paquet by doing a simulation with mrgsolve. For a more detailed example, see the File Stream vignette by running this command:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/vignette.html" class="external-link">vignette</a></span><span class="op">(</span><span class="st">"file-stream"</span>, package <span class="op">=</span> <span class="st">"paquet"</span><span class="op">)</span></span></code></pre></div>
<p>Let’s create an input data set to simulate.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://metrumresearchgroup.github.io/paquet">paquet</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://mrgsolve.org/docs/" class="external-link">mrgsolve</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://mrgsolve.org/docs/reference/expand.idata.html" class="external-link">expand.ev</a></span><span class="op">(</span></span>
<span>  ID <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">100</span><span class="op">)</span>, </span>
<span>  amt <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">100</span>, <span class="fl">300</span>, <span class="fl">1000</span><span class="op">)</span>, </span>
<span>  ii <span class="op">=</span> <span class="fl">24</span>, </span>
<span>  addl <span class="op">=</span> <span class="fl">9</span></span>
<span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html" class="external-link">as_tibble</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>dose <span class="op">=</span> <span class="va">amt</span><span class="op">)</span></span></code></pre></div>
<p>This isn’t huge, but we’re just illustrating</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" tabindex="-1"></a>data</span>
<span id="cb4-2"><a href="#cb4-2" tabindex="-1"></a>. <span class="co"># A tibble: 300 × 8</span></span>
<span id="cb4-3"><a href="#cb4-3" tabindex="-1"></a>.       ID  time   amt    ii  addl   cmt  evid  dose</span>
<span id="cb4-4"><a href="#cb4-4" tabindex="-1"></a>.    <span class="sc">&lt;</span>int<span class="sc">&gt;</span> <span class="er">&lt;</span>dbl<span class="sc">&gt;</span> <span class="er">&lt;</span>dbl<span class="sc">&gt;</span> <span class="er">&lt;</span>dbl<span class="sc">&gt;</span> <span class="er">&lt;</span>dbl<span class="sc">&gt;</span> <span class="er">&lt;</span>dbl<span class="sc">&gt;</span> <span class="er">&lt;</span>dbl<span class="sc">&gt;</span> <span class="er">&lt;</span>dbl<span class="sc">&gt;</span></span>
<span id="cb4-5"><a href="#cb4-5" tabindex="-1"></a>.  <span class="dv">1</span>     <span class="dv">1</span>     <span class="dv">0</span>   <span class="dv">100</span>    <span class="dv">24</span>     <span class="dv">9</span>     <span class="dv">1</span>     <span class="dv">1</span>   <span class="dv">100</span></span>
<span id="cb4-6"><a href="#cb4-6" tabindex="-1"></a>.  <span class="dv">2</span>     <span class="dv">2</span>     <span class="dv">0</span>   <span class="dv">100</span>    <span class="dv">24</span>     <span class="dv">9</span>     <span class="dv">1</span>     <span class="dv">1</span>   <span class="dv">100</span></span>
<span id="cb4-7"><a href="#cb4-7" tabindex="-1"></a>.  <span class="dv">3</span>     <span class="dv">3</span>     <span class="dv">0</span>   <span class="dv">100</span>    <span class="dv">24</span>     <span class="dv">9</span>     <span class="dv">1</span>     <span class="dv">1</span>   <span class="dv">100</span></span>
<span id="cb4-8"><a href="#cb4-8" tabindex="-1"></a>.  <span class="dv">4</span>     <span class="dv">4</span>     <span class="dv">0</span>   <span class="dv">100</span>    <span class="dv">24</span>     <span class="dv">9</span>     <span class="dv">1</span>     <span class="dv">1</span>   <span class="dv">100</span></span>
<span id="cb4-9"><a href="#cb4-9" tabindex="-1"></a>.  <span class="dv">5</span>     <span class="dv">5</span>     <span class="dv">0</span>   <span class="dv">100</span>    <span class="dv">24</span>     <span class="dv">9</span>     <span class="dv">1</span>     <span class="dv">1</span>   <span class="dv">100</span></span>
<span id="cb4-10"><a href="#cb4-10" tabindex="-1"></a>.  <span class="dv">6</span>     <span class="dv">6</span>     <span class="dv">0</span>   <span class="dv">100</span>    <span class="dv">24</span>     <span class="dv">9</span>     <span class="dv">1</span>     <span class="dv">1</span>   <span class="dv">100</span></span>
<span id="cb4-11"><a href="#cb4-11" tabindex="-1"></a>.  <span class="dv">7</span>     <span class="dv">7</span>     <span class="dv">0</span>   <span class="dv">100</span>    <span class="dv">24</span>     <span class="dv">9</span>     <span class="dv">1</span>     <span class="dv">1</span>   <span class="dv">100</span></span>
<span id="cb4-12"><a href="#cb4-12" tabindex="-1"></a>.  <span class="dv">8</span>     <span class="dv">8</span>     <span class="dv">0</span>   <span class="dv">100</span>    <span class="dv">24</span>     <span class="dv">9</span>     <span class="dv">1</span>     <span class="dv">1</span>   <span class="dv">100</span></span>
<span id="cb4-13"><a href="#cb4-13" tabindex="-1"></a>.  <span class="dv">9</span>     <span class="dv">9</span>     <span class="dv">0</span>   <span class="dv">100</span>    <span class="dv">24</span>     <span class="dv">9</span>     <span class="dv">1</span>     <span class="dv">1</span>   <span class="dv">100</span></span>
<span id="cb4-14"><a href="#cb4-14" tabindex="-1"></a>. <span class="dv">10</span>    <span class="dv">10</span>     <span class="dv">0</span>   <span class="dv">100</span>    <span class="dv">24</span>     <span class="dv">9</span>     <span class="dv">1</span>     <span class="dv">1</span>   <span class="dv">100</span></span>
<span id="cb4-15"><a href="#cb4-15" tabindex="-1"></a>. <span class="co"># … with 290 more rows</span></span></code></pre></div>
<p>A workflow might be to create chunks to process in parallel on a worker node. To do this, we’ll create a file stream based on chunks of the input data</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fs</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/new_stream.html">new_stream</a></span><span class="op">(</span><span class="va">data</span>, nchunk <span class="op">=</span> <span class="fl">5</span>, locker <span class="op">=</span> <span class="st">"foo/mrgsolve"</span>, format <span class="op">=</span> <span class="st">"feather"</span><span class="op">)</span></span></code></pre></div>
<p>This returns a list of data chunks</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" tabindex="-1"></a>fs[[<span class="dv">5</span>]]</span>
<span id="cb6-2"><a href="#cb6-2" tabindex="-1"></a>. <span class="sc">$</span>i</span>
<span id="cb6-3"><a href="#cb6-3" tabindex="-1"></a>. [<span class="dv">1</span>] <span class="dv">5</span></span>
<span id="cb6-4"><a href="#cb6-4" tabindex="-1"></a>. </span>
<span id="cb6-5"><a href="#cb6-5" tabindex="-1"></a>. <span class="sc">$</span>file</span>
<span id="cb6-6"><a href="#cb6-6" tabindex="-1"></a>. [<span class="dv">1</span>] <span class="st">"foo/mrgsolve/5-5.feather"</span></span>
<span id="cb6-7"><a href="#cb6-7" tabindex="-1"></a>. </span>
<span id="cb6-8"><a href="#cb6-8" tabindex="-1"></a>. <span class="sc">$</span>x</span>
<span id="cb6-9"><a href="#cb6-9" tabindex="-1"></a>. <span class="co"># A tibble: 60 × 8</span></span>
<span id="cb6-10"><a href="#cb6-10" tabindex="-1"></a>.       ID  time   amt    ii  addl   cmt  evid  dose</span>
<span id="cb6-11"><a href="#cb6-11" tabindex="-1"></a>.    <span class="sc">&lt;</span>int<span class="sc">&gt;</span> <span class="er">&lt;</span>dbl<span class="sc">&gt;</span> <span class="er">&lt;</span>dbl<span class="sc">&gt;</span> <span class="er">&lt;</span>dbl<span class="sc">&gt;</span> <span class="er">&lt;</span>dbl<span class="sc">&gt;</span> <span class="er">&lt;</span>dbl<span class="sc">&gt;</span> <span class="er">&lt;</span>dbl<span class="sc">&gt;</span> <span class="er">&lt;</span>dbl<span class="sc">&gt;</span></span>
<span id="cb6-12"><a href="#cb6-12" tabindex="-1"></a>.  <span class="dv">1</span>   <span class="dv">241</span>     <span class="dv">0</span>  <span class="dv">1000</span>    <span class="dv">24</span>     <span class="dv">9</span>     <span class="dv">1</span>     <span class="dv">1</span>  <span class="dv">1000</span></span>
<span id="cb6-13"><a href="#cb6-13" tabindex="-1"></a>.  <span class="dv">2</span>   <span class="dv">242</span>     <span class="dv">0</span>  <span class="dv">1000</span>    <span class="dv">24</span>     <span class="dv">9</span>     <span class="dv">1</span>     <span class="dv">1</span>  <span class="dv">1000</span></span>
<span id="cb6-14"><a href="#cb6-14" tabindex="-1"></a>.  <span class="dv">3</span>   <span class="dv">243</span>     <span class="dv">0</span>  <span class="dv">1000</span>    <span class="dv">24</span>     <span class="dv">9</span>     <span class="dv">1</span>     <span class="dv">1</span>  <span class="dv">1000</span></span>
<span id="cb6-15"><a href="#cb6-15" tabindex="-1"></a>.  <span class="dv">4</span>   <span class="dv">244</span>     <span class="dv">0</span>  <span class="dv">1000</span>    <span class="dv">24</span>     <span class="dv">9</span>     <span class="dv">1</span>     <span class="dv">1</span>  <span class="dv">1000</span></span>
<span id="cb6-16"><a href="#cb6-16" tabindex="-1"></a>.  <span class="dv">5</span>   <span class="dv">245</span>     <span class="dv">0</span>  <span class="dv">1000</span>    <span class="dv">24</span>     <span class="dv">9</span>     <span class="dv">1</span>     <span class="dv">1</span>  <span class="dv">1000</span></span>
<span id="cb6-17"><a href="#cb6-17" tabindex="-1"></a>.  <span class="dv">6</span>   <span class="dv">246</span>     <span class="dv">0</span>  <span class="dv">1000</span>    <span class="dv">24</span>     <span class="dv">9</span>     <span class="dv">1</span>     <span class="dv">1</span>  <span class="dv">1000</span></span>
<span id="cb6-18"><a href="#cb6-18" tabindex="-1"></a>.  <span class="dv">7</span>   <span class="dv">247</span>     <span class="dv">0</span>  <span class="dv">1000</span>    <span class="dv">24</span>     <span class="dv">9</span>     <span class="dv">1</span>     <span class="dv">1</span>  <span class="dv">1000</span></span>
<span id="cb6-19"><a href="#cb6-19" tabindex="-1"></a>.  <span class="dv">8</span>   <span class="dv">248</span>     <span class="dv">0</span>  <span class="dv">1000</span>    <span class="dv">24</span>     <span class="dv">9</span>     <span class="dv">1</span>     <span class="dv">1</span>  <span class="dv">1000</span></span>
<span id="cb6-20"><a href="#cb6-20" tabindex="-1"></a>.  <span class="dv">9</span>   <span class="dv">249</span>     <span class="dv">0</span>  <span class="dv">1000</span>    <span class="dv">24</span>     <span class="dv">9</span>     <span class="dv">1</span>     <span class="dv">1</span>  <span class="dv">1000</span></span>
<span id="cb6-21"><a href="#cb6-21" tabindex="-1"></a>. <span class="dv">10</span>   <span class="dv">250</span>     <span class="dv">0</span>  <span class="dv">1000</span>    <span class="dv">24</span>     <span class="dv">9</span>     <span class="dv">1</span>     <span class="dv">1</span>  <span class="dv">1000</span></span>
<span id="cb6-22"><a href="#cb6-22" tabindex="-1"></a>. <span class="co"># … with 50 more rows</span></span>
<span id="cb6-23"><a href="#cb6-23" tabindex="-1"></a>. </span>
<span id="cb6-24"><a href="#cb6-24" tabindex="-1"></a>. <span class="fu">attr</span>(,<span class="st">"file_set_item"</span>)</span>
<span id="cb6-25"><a href="#cb6-25" tabindex="-1"></a>. [<span class="dv">1</span>] <span class="cn">TRUE</span></span>
<span id="cb6-26"><a href="#cb6-26" tabindex="-1"></a>. <span class="fu">attr</span>(,<span class="st">"class"</span>)</span>
<span id="cb6-27"><a href="#cb6-27" tabindex="-1"></a>. [<span class="dv">1</span>] <span class="st">"stream_format_feather"</span> <span class="st">"list"</span></span></code></pre></div>
<p>For example, the 5th chunk will be saved to</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode R"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" tabindex="-1"></a>. [<span class="dv">1</span>] <span class="st">"foo/mrgsolve/5-5.feather"</span></span></code></pre></div>
<p>in <code>feather</code> format.</p>
<p>We create a function to generate the outputs and then call <code><a href="reference/write_stream.html">write_stream()</a></code> to write the outputs to file</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mod</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://mrgsolve.org/docs/reference/modlib.html" class="external-link">modlib</a></span><span class="op">(</span><span class="st">"popex"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">simulate_chunk</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span></span>
<span>  </span>
<span>  <span class="va">out</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://mrgsolve.org/docs/reference/mrgsim.html" class="external-link">mrgsim_df</a></span><span class="op">(</span><span class="va">mod</span>, data <span class="op">=</span> <span class="va">x</span><span class="op">$</span><span class="va">x</span>, carry_out <span class="op">=</span> <span class="st">"dose"</span><span class="op">)</span>  </span>
<span>  </span>
<span>  <span class="fu"><a href="reference/write_stream.html">write_stream</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">out</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">x</span><span class="op">$</span><span class="va">file</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">out</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">fs</span>, <span class="va">simulate_chunk</span><span class="op">)</span></span></code></pre></div>
<p>Now all of our outputs are safely stored in <code>feather</code> format</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" tabindex="-1"></a><span class="fu">list.files</span>(<span class="st">"foo/mrgsolve"</span>)</span>
<span id="cb9-2"><a href="#cb9-2" tabindex="-1"></a>. [<span class="dv">1</span>] <span class="st">"1-5.feather"</span> <span class="st">"2-5.feather"</span> <span class="st">"3-5.feather"</span> <span class="st">"4-5.feather"</span> <span class="st">"5-5.feather"</span></span></code></pre></div>
<p>And we have the file names in <code>out</code> since we returned the file names rather than the simulated data</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" tabindex="-1"></a>out</span>
<span id="cb10-2"><a href="#cb10-2" tabindex="-1"></a>. [[<span class="dv">1</span>]]</span>
<span id="cb10-3"><a href="#cb10-3" tabindex="-1"></a>. [<span class="dv">1</span>] <span class="st">"foo/mrgsolve/1-5.feather"</span></span>
<span id="cb10-4"><a href="#cb10-4" tabindex="-1"></a>. </span>
<span id="cb10-5"><a href="#cb10-5" tabindex="-1"></a>. [[<span class="dv">2</span>]]</span>
<span id="cb10-6"><a href="#cb10-6" tabindex="-1"></a>. [<span class="dv">1</span>] <span class="st">"foo/mrgsolve/2-5.feather"</span></span>
<span id="cb10-7"><a href="#cb10-7" tabindex="-1"></a>. </span>
<span id="cb10-8"><a href="#cb10-8" tabindex="-1"></a>. [[<span class="dv">3</span>]]</span>
<span id="cb10-9"><a href="#cb10-9" tabindex="-1"></a>. [<span class="dv">1</span>] <span class="st">"foo/mrgsolve/3-5.feather"</span></span>
<span id="cb10-10"><a href="#cb10-10" tabindex="-1"></a>. </span>
<span id="cb10-11"><a href="#cb10-11" tabindex="-1"></a>. [[<span class="dv">4</span>]]</span>
<span id="cb10-12"><a href="#cb10-12" tabindex="-1"></a>. [<span class="dv">1</span>] <span class="st">"foo/mrgsolve/4-5.feather"</span></span>
<span id="cb10-13"><a href="#cb10-13" tabindex="-1"></a>. </span>
<span id="cb10-14"><a href="#cb10-14" tabindex="-1"></a>. [[<span class="dv">5</span>]]</span>
<span id="cb10-15"><a href="#cb10-15" tabindex="-1"></a>. [<span class="dv">1</span>] <span class="st">"foo/mrgsolve/5-5.feather"</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="using-arrow-to-read-paquet-outputs">Using <code>arrow</code> to read paquet outputs<a class="anchor" aria-label="anchor" href="#using-arrow-to-read-paquet-outputs"></a>
</h2>
<p>Apache arrow is an advance platform for handling very large data sets. While there is no formal connection between paquet and arrow, paquet has been designed to set up output files in a way that makes it easy to access with arrow.</p>
<p>We used <code>format = "feather"</code> in the mrgsolve simulation above and saved the files out to a locker space on disk. We can read these simulations using the <code>open_dataset()</code> function provided by arrow</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" tabindex="-1"></a><span class="fu">library</span>(arrow)</span>
<span id="cb11-2"><a href="#cb11-2" tabindex="-1"></a></span>
<span id="cb11-3"><a href="#cb11-3" tabindex="-1"></a>ds <span class="ot">&lt;-</span> <span class="fu">open_dataset</span>(<span class="st">"foo/mrgsolve"</span>, <span class="at">format =</span> <span class="st">"feather"</span>)</span>
<span id="cb11-4"><a href="#cb11-4" tabindex="-1"></a></span>
<span id="cb11-5"><a href="#cb11-5" tabindex="-1"></a>ds</span>
<span id="cb11-6"><a href="#cb11-6" tabindex="-1"></a>. FileSystemDataset with <span class="dv">5</span> Feather files</span>
<span id="cb11-7"><a href="#cb11-7" tabindex="-1"></a>. ID<span class="sc">:</span> double</span>
<span id="cb11-8"><a href="#cb11-8" tabindex="-1"></a>. time<span class="sc">:</span> double</span>
<span id="cb11-9"><a href="#cb11-9" tabindex="-1"></a>. dose<span class="sc">:</span> double</span>
<span id="cb11-10"><a href="#cb11-10" tabindex="-1"></a>. GUT<span class="sc">:</span> double</span>
<span id="cb11-11"><a href="#cb11-11" tabindex="-1"></a>. CENT<span class="sc">:</span> double</span>
<span id="cb11-12"><a href="#cb11-12" tabindex="-1"></a>. CL<span class="sc">:</span> double</span>
<span id="cb11-13"><a href="#cb11-13" tabindex="-1"></a>. V<span class="sc">:</span> double</span>
<span id="cb11-14"><a href="#cb11-14" tabindex="-1"></a>. ECL<span class="sc">:</span> double</span>
<span id="cb11-15"><a href="#cb11-15" tabindex="-1"></a>. IPRED<span class="sc">:</span> double</span>
<span id="cb11-16"><a href="#cb11-16" tabindex="-1"></a>. DV<span class="sc">:</span> double</span>
<span id="cb11-17"><a href="#cb11-17" tabindex="-1"></a>. </span>
<span id="cb11-18"><a href="#cb11-18" tabindex="-1"></a>. See <span class="sc">$</span>metadata <span class="cf">for</span> additional Schema metadata</span></code></pre></div>
<p>This doesn’t read in the data, but just gets a handle on what is there. Using arrow, we can filter and select the data that we want from the feather files <strong>before</strong> actually reading the files so that we don’t have to read data that we don’t ultimately want</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" tabindex="-1"></a>sims <span class="ot">&lt;-</span> </span>
<span id="cb12-2"><a href="#cb12-2" tabindex="-1"></a>  ds <span class="sc">%&gt;%</span></span>
<span id="cb12-3"><a href="#cb12-3" tabindex="-1"></a>  <span class="fu">filter</span>(dose <span class="sc">==</span> <span class="dv">100</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-4"><a href="#cb12-4" tabindex="-1"></a>  <span class="fu">select</span>(ID, time, DV) <span class="sc">%&gt;%</span> </span>
<span id="cb12-5"><a href="#cb12-5" tabindex="-1"></a>  <span class="fu">as_tibble</span>()</span>
<span id="cb12-6"><a href="#cb12-6" tabindex="-1"></a></span>
<span id="cb12-7"><a href="#cb12-7" tabindex="-1"></a>sims</span>
<span id="cb12-8"><a href="#cb12-8" tabindex="-1"></a>. <span class="co"># A tibble: 48,200 × 3</span></span>
<span id="cb12-9"><a href="#cb12-9" tabindex="-1"></a>.       ID  time    DV</span>
<span id="cb12-10"><a href="#cb12-10" tabindex="-1"></a>.    <span class="sc">&lt;</span>dbl<span class="sc">&gt;</span> <span class="er">&lt;</span>dbl<span class="sc">&gt;</span> <span class="er">&lt;</span>dbl<span class="sc">&gt;</span></span>
<span id="cb12-11"><a href="#cb12-11" tabindex="-1"></a>.  <span class="dv">1</span>    <span class="dv">61</span>   <span class="dv">0</span>    <span class="dv">0</span>   </span>
<span id="cb12-12"><a href="#cb12-12" tabindex="-1"></a>.  <span class="dv">2</span>    <span class="dv">61</span>   <span class="dv">0</span>    <span class="dv">0</span>   </span>
<span id="cb12-13"><a href="#cb12-13" tabindex="-1"></a>.  <span class="dv">3</span>    <span class="dv">61</span>   <span class="fl">0.5</span>  <span class="fl">1.55</span></span>
<span id="cb12-14"><a href="#cb12-14" tabindex="-1"></a>.  <span class="dv">4</span>    <span class="dv">61</span>   <span class="dv">1</span>    <span class="fl">2.66</span></span>
<span id="cb12-15"><a href="#cb12-15" tabindex="-1"></a>.  <span class="dv">5</span>    <span class="dv">61</span>   <span class="fl">1.5</span>  <span class="fl">3.45</span></span>
<span id="cb12-16"><a href="#cb12-16" tabindex="-1"></a>.  <span class="dv">6</span>    <span class="dv">61</span>   <span class="dv">2</span>    <span class="fl">4.01</span></span>
<span id="cb12-17"><a href="#cb12-17" tabindex="-1"></a>.  <span class="dv">7</span>    <span class="dv">61</span>   <span class="fl">2.5</span>  <span class="fl">4.40</span></span>
<span id="cb12-18"><a href="#cb12-18" tabindex="-1"></a>.  <span class="dv">8</span>    <span class="dv">61</span>   <span class="dv">3</span>    <span class="fl">4.66</span></span>
<span id="cb12-19"><a href="#cb12-19" tabindex="-1"></a>.  <span class="dv">9</span>    <span class="dv">61</span>   <span class="fl">3.5</span>  <span class="fl">4.83</span></span>
<span id="cb12-20"><a href="#cb12-20" tabindex="-1"></a>. <span class="dv">10</span>    <span class="dv">61</span>   <span class="dv">4</span>    <span class="fl">4.93</span></span>
<span id="cb12-21"><a href="#cb12-21" tabindex="-1"></a>. <span class="co"># … with 48,190 more rows</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="using-fst-to-save-and-read-outputs">Using <code>fst</code> to save and read outputs<a class="anchor" aria-label="anchor" href="#using-fst-to-save-and-read-outputs"></a>
</h2>
<p>In the previous example, we used the <code>feather</code> format to save simulated outputs and interacted with the outputs using <code><a href="https://arrow.apache.org/docs/r/reference/open_dataset.html" class="external-link">arrow::open_dataset()</a></code>. We can use the <em>same</em> simulation function and save files to fst format instead</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fs2</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/new_stream.html">new_stream</a></span><span class="op">(</span><span class="va">data</span>, nchunk <span class="op">=</span> <span class="fl">5</span>, format <span class="op">=</span> <span class="st">"fst"</span>, locker <span class="op">=</span> <span class="st">"foo/fst-output"</span><span class="op">)</span></span></code></pre></div>
<p>Note we have requested fst formatted outputs and have pointed to a new space on disk. We simulate again using <code>simulate_chunk</code></p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">out</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">fs2</span>, <span class="va">simulate_chunk</span><span class="op">)</span></span></code></pre></div>
<p>Now we <em>can’t</em> use arrow to read these files, but we can use fst. paquet provides tools for internalizing <code>fst</code> outputs</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" tabindex="-1"></a>sims2 <span class="ot">&lt;-</span> <span class="fu">internalize_fst</span>(<span class="st">"foo/fst-output"</span>) <span class="sc">%&gt;%</span> <span class="fu">bind_rows</span>()</span>
<span id="cb15-2"><a href="#cb15-2" tabindex="-1"></a></span>
<span id="cb15-3"><a href="#cb15-3" tabindex="-1"></a><span class="fu">head</span>(sims2)</span>
<span id="cb15-4"><a href="#cb15-4" tabindex="-1"></a>.   ID time dose        GUT     CENT        CL        V         ECL    IPRED</span>
<span id="cb15-5"><a href="#cb15-5" tabindex="-1"></a>. <span class="dv">1</span>  <span class="dv">1</span>  <span class="fl">0.0</span>  <span class="dv">100</span>   <span class="fl">0.000000</span>  <span class="fl">0.00000</span> <span class="fl">0.9205288</span> <span class="fl">14.84469</span> <span class="sc">-</span><span class="fl">0.08280697</span> <span class="fl">0.000000</span></span>
<span id="cb15-6"><a href="#cb15-6" tabindex="-1"></a>. <span class="dv">2</span>  <span class="dv">1</span>  <span class="fl">0.0</span>  <span class="dv">100</span> <span class="fl">100.000000</span>  <span class="fl">0.00000</span> <span class="fl">0.9205288</span> <span class="fl">14.84469</span> <span class="sc">-</span><span class="fl">0.08280697</span> <span class="fl">0.000000</span></span>
<span id="cb15-7"><a href="#cb15-7" tabindex="-1"></a>. <span class="dv">3</span>  <span class="dv">1</span>  <span class="fl">0.5</span>  <span class="dv">100</span>  <span class="fl">48.456256</span> <span class="fl">50.65872</span> <span class="fl">0.9205288</span> <span class="fl">14.84469</span> <span class="sc">-</span><span class="fl">0.08280697</span> <span class="fl">3.412582</span></span>
<span id="cb15-8"><a href="#cb15-8" tabindex="-1"></a>. <span class="dv">4</span>  <span class="dv">1</span>  <span class="fl">1.0</span>  <span class="dv">100</span>  <span class="fl">23.480087</span> <span class="fl">73.65945</span> <span class="fl">0.9205288</span> <span class="fl">14.84469</span> <span class="sc">-</span><span class="fl">0.08280697</span> <span class="fl">4.962007</span></span>
<span id="cb15-9"><a href="#cb15-9" tabindex="-1"></a>. <span class="dv">5</span>  <span class="dv">1</span>  <span class="fl">1.5</span>  <span class="dv">100</span>  <span class="fl">11.377571</span> <span class="fl">83.30537</span> <span class="fl">0.9205288</span> <span class="fl">14.84469</span> <span class="sc">-</span><span class="fl">0.08280697</span> <span class="fl">5.611796</span></span>
<span id="cb15-10"><a href="#cb15-10" tabindex="-1"></a>. <span class="dv">6</span>  <span class="dv">1</span>  <span class="fl">2.0</span>  <span class="dv">100</span>   <span class="fl">5.513145</span> <span class="fl">86.52583</span> <span class="fl">0.9205288</span> <span class="fl">14.84469</span> <span class="sc">-</span><span class="fl">0.08280697</span> <span class="fl">5.828739</span></span>
<span id="cb15-11"><a href="#cb15-11" tabindex="-1"></a>.         DV</span>
<span id="cb15-12"><a href="#cb15-12" tabindex="-1"></a>. <span class="dv">1</span> <span class="fl">0.000000</span></span>
<span id="cb15-13"><a href="#cb15-13" tabindex="-1"></a>. <span class="dv">2</span> <span class="fl">0.000000</span></span>
<span id="cb15-14"><a href="#cb15-14" tabindex="-1"></a>. <span class="dv">3</span> <span class="fl">3.412582</span></span>
<span id="cb15-15"><a href="#cb15-15" tabindex="-1"></a>. <span class="dv">4</span> <span class="fl">4.962007</span></span>
<span id="cb15-16"><a href="#cb15-16" tabindex="-1"></a>. <span class="dv">5</span> <span class="fl">5.611796</span></span>
<span id="cb15-17"><a href="#cb15-17" tabindex="-1"></a>. <span class="dv">6</span> <span class="fl">5.828739</span></span></code></pre></div>
<p>as well as tooling to process them sequentially.</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://r-datatable.com" class="external-link">data.table</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="http://www.fstpackage.org" class="external-link">fst</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">files</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/list_fst.html">list_fst</a></span><span class="op">(</span><span class="st">"foo/fst-output"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">sims3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">files</span>, <span class="kw">function</span><span class="op">(</span><span class="va">file</span><span class="op">)</span> <span class="op">{</span></span>
<span>  </span>
<span>  <span class="va">result</span> <span class="op">&lt;-</span> <span class="fu"><a href="http://www.fstpackage.org/reference/write_fst.html" class="external-link">read_fst</a></span><span class="op">(</span><span class="va">file</span>, as.data.table <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">result</span><span class="op">[</span><span class="va">dose</span> <span class="op">==</span> <span class="fl">100</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"ID"</span>, <span class="st">"time"</span>, <span class="st">"DV"</span><span class="op">)</span><span class="op">]</span></span>
<span></span>
<span><span class="op">}</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu">rbindlist</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p>While the fst package is configured to work with <code>data.table</code>, it is not required. However, it might be recommended if processing very large outputs.</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" tabindex="-1"></a>sims3</span>
<span id="cb17-2"><a href="#cb17-2" tabindex="-1"></a>.         ID  time       DV</span>
<span id="cb17-3"><a href="#cb17-3" tabindex="-1"></a>.     <span class="dv">1</span><span class="sc">:</span>   <span class="dv">1</span>   <span class="fl">0.0</span> <span class="fl">0.000000</span></span>
<span id="cb17-4"><a href="#cb17-4" tabindex="-1"></a>.     <span class="dv">2</span><span class="sc">:</span>   <span class="dv">1</span>   <span class="fl">0.0</span> <span class="fl">0.000000</span></span>
<span id="cb17-5"><a href="#cb17-5" tabindex="-1"></a>.     <span class="dv">3</span><span class="sc">:</span>   <span class="dv">1</span>   <span class="fl">0.5</span> <span class="fl">3.412582</span></span>
<span id="cb17-6"><a href="#cb17-6" tabindex="-1"></a>.     <span class="dv">4</span><span class="sc">:</span>   <span class="dv">1</span>   <span class="fl">1.0</span> <span class="fl">4.962007</span></span>
<span id="cb17-7"><a href="#cb17-7" tabindex="-1"></a>.     <span class="dv">5</span><span class="sc">:</span>   <span class="dv">1</span>   <span class="fl">1.5</span> <span class="fl">5.611796</span></span>
<span id="cb17-8"><a href="#cb17-8" tabindex="-1"></a>.    <span class="sc">---</span>                   </span>
<span id="cb17-9"><a href="#cb17-9" tabindex="-1"></a>. <span class="dv">48196</span><span class="sc">:</span> <span class="dv">100</span> <span class="fl">238.0</span> <span class="fl">4.871450</span></span>
<span id="cb17-10"><a href="#cb17-10" tabindex="-1"></a>. <span class="dv">48197</span><span class="sc">:</span> <span class="dv">100</span> <span class="fl">238.5</span> <span class="fl">4.819019</span></span>
<span id="cb17-11"><a href="#cb17-11" tabindex="-1"></a>. <span class="dv">48198</span><span class="sc">:</span> <span class="dv">100</span> <span class="fl">239.0</span> <span class="fl">4.766864</span></span>
<span id="cb17-12"><a href="#cb17-12" tabindex="-1"></a>. <span class="dv">48199</span><span class="sc">:</span> <span class="dv">100</span> <span class="fl">239.5</span> <span class="fl">4.715013</span></span>
<span id="cb17-13"><a href="#cb17-13" tabindex="-1"></a>. <span class="dv">48200</span><span class="sc">:</span> <span class="dv">100</span> <span class="fl">240.0</span> <span class="fl">4.663491</span></span></code></pre></div>
</div>
</div>
  </main><aside class="col-md-3"><div class="links">
<h2 data-toc-skip>Links</h2>
<ul class="list-unstyled">
<li><a href="https://github.com/metrumresearchgroup/paquet/" class="external-link">Browse source code</a></li>
<li><a href="https://github.com/metrumresearchgroup/paquet/issues" class="external-link">Report a bug</a></li>
</ul>
</div>

<div class="license">
<h2 data-toc-skip>License</h2>
<ul class="list-unstyled">
<li>GPL (&gt;=2)</li>
</ul>
</div>


<div class="citation">
<h2 data-toc-skip>Citation</h2>
<ul class="list-unstyled">
<li><a href="authors.html#citation">Citing paquet</a></li>
</ul>
</div>

<div class="developers">
<h2 data-toc-skip>Developers</h2>
<ul class="list-unstyled">
<li>Kyle T Baron <br><small class="roles"> Author, maintainer </small> <a href="https://orcid.org/0000-0001-7252-5656" target="orcid.widget" aria-label="ORCID" class="external-link"><span class="fab fa-orcid orcid" aria-hidden="true"></span></a> </li>
<li><a href="authors.html">More about authors...</a></li>
</ul>
</div>



  </aside>
</div>


    <footer><div class="pkgdown-footer-left">
  <p>Developed by Kyle T Baron.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer>
</div>





  </body>
</html>
